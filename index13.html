<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movies & Series I Loved ‚Äî Darshan's Picks</title>
  <style>
    :root {
      /* Modern Color Palette - Deep Purple & Cyan Accent */
      --bg-primary: #0a0e27;
      --bg-secondary: #0f1435;
      --bg-card: rgba(20, 25, 60, 0.4);
      --bg-glass: rgba(255, 255, 255, 0.05);
      --bg-glass-hover: rgba(255, 255, 255, 0.08);
      
      /* Gradient Accents */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warm: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      
      /* Text Colors */
      --text-primary: #e8eaf6;
      --text-secondary: #9fa8da;
      --text-muted: #7986cb;
      --text-accent: #bb86fc;
      
      /* Accent Colors */
      --accent-primary: #667eea;
      --accent-secondary: #00f2fe;
      --accent-pink: #f093fb;
      --accent-warning: #ffd93d;
      
      /* Shadows & Effects */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.3);
      
      /* Layout */
      --maxw: 1200px;
      --border-radius: 16px;
      --border-radius-sm: 12px;
      
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      background: var(--bg-primary);
      background-image: 
        radial-gradient(at 10% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(at 90% 80%, rgba(240, 147, 251, 0.08) 0%, transparent 50%);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      min-height: 100vh;
    }
    
    .wrap {
      width: 100%;
      max-width: var(--maxw);
    }
    
    /* Header Styles */
    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding: 24px;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-md);
    }
    
    .logo {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #fff;
      font-size: 28px;
      box-shadow: var(--shadow-glow);
      flex-shrink: 0;
    }
    
    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    p.lead {
      margin: 6px 0 0;
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Controls Section */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 24px 0;
      flex-wrap: wrap;
    }
    
    .search {
      flex: 1 1 320px;
      min-width: 250px;
    }
    
    input[type=search] {
      width: 100%;
      padding: 14px 18px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-size: 15px;
      transition: all 0.3s ease;
      outline: none;
    }
    
    input[type=search]:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }
    
    input[type=search]::placeholder {
      color: var(--text-muted);
    }
    
    /* Button Styles */
    #suggestRandom {
      padding: 14px 24px;
      border-radius: var(--border-radius-sm);
      background: var(--gradient-accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      min-width: 160px;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    #suggestRandom:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
    }
    
    #suggestRandom:active {
      transform: translateY(0);
    }
    
    .filter-wrap {
      position: relative;
      min-width: 200px;
    }
    
    .filter-btn {
      padding: 14px 20px;
      border-radius: var(--border-radius-sm);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
      background: var(--bg-glass-hover);
      border-color: var(--accent-primary);
    }
    
    .filter-btn::after {
      content: '‚ñº';
      font-size: 12px;
      transition: transform 0.3s ease;
    }
    
    .filter-btn[aria-expanded="true"]::after {
      transform: rotate(180deg);
    }
    
    .filter-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 240px;
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius-sm);
      display: none;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      max-height: 320px;
      overflow-y: auto;
      padding: 8px;
    }
    
    .filter-menu.open {
      display: flex;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .filter-item {
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .filter-item:hover {
      background: var(--bg-glass);
      color: var(--text-primary);
    }
    
    .filter-item input[type=checkbox] {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--accent-primary);
    }
    
    /* Genre Section */
    .genre-section {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .genre-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .genre-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .clear-genres-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-secondary);
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .clear-genres-btn:hover {
      background: var(--bg-glass-hover);
      color: var(--text-primary);
      border-color: var(--accent-primary);
    }
    
    .taglist {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .tag {
      color: var(--text-primary);
      padding: 10px 18px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .tag input[type=checkbox] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    
    .tag:hover {
      background: var(--bg-glass-hover);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }
    
    .tag.active {
      background: var(--gradient-primary);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* Ad Space */
    .ad {
      width: 100%;
      min-height: 100px;
      border-radius: var(--border-radius);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      margin: 24px 0;
      font-size: 14px;
    }
    
    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    
    /* Card Styles */
    .card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      height: 520px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-8px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .poster-wrapper {
      width: 100%;
      height: 320px;
      background: var(--bg-primary);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 14px;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    
    .poster-wrapper::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(10, 14, 39, 0.9) 100%);
      pointer-events: none;
    }
    
    .poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .card:hover .poster {
      transform: scale(1.05);
    }
    
    .title {
      font-weight: 700;
      margin: 0 0 8px;
      font-size: 18px;
      line-height: 1.3;
      color: var(--text-primary);
    }
    
    .meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    .classification {
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      color: var(--accent-secondary);
      padding: 4px 10px;
      background: rgba(0, 242, 254, 0.1);
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .small {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
    }
    
    .rating {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(255, 211, 61, 0.1);
      color: var(--accent-warning);
      font-weight: 700;
      font-size: 13px;
    }
    
    /* Button Group */
    .btn-group {
      display: flex;
      gap: 10px;
      background: var(--bg-glass);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius-sm);
      padding: 12px;
      margin-top: auto;
      transition: all 0.3s ease;
    }
    
    .card:hover .btn-group {
      border-color: var(--accent-primary);
      background: var(--bg-glass-hover);
    }
    
    .btn {
      flex: 1;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .btn:hover {
      background: var(--gradient-primary);
      color: #fff;
      transform: scale(1.05);
      box-shadow: var(--shadow-md);
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal.open {
      display: flex;
    }
    
    .modal-card {
      width: 100%;
      max-width: 950px;
      background: var(--bg-secondary);
      backdrop-filter: blur(40px);
      border-radius: var(--border-radius);
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--shadow-lg);
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
      margin-top: 20px;
    }
    
    .video-container {
      width: 100%;
      height: 100%;
      background: #000;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    
    .video-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    
    .modal-poster {
      width: 100%;
      height: 450px;
      object-fit: cover;
      border-radius: var(--border-radius-sm);
      display: block;
      box-shadow: var(--shadow-md);
    }
    
    .modal-poster.hidden {
      display: none;
    }
    
    .close {
      background: var(--bg-glass);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .close:hover {
      background: var(--gradient-accent);
      color: #fff;
      border-color: transparent;
      transform: rotate(90deg);
    }
    
    /* Footer */
    footer {
      margin-top: 32px;
      padding: 24px;
      color: var(--text-muted);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      gap: 20px;
      flex-wrap: wrap;
    }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .modal-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-poster,
      .video-container {
        height: 280px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      .logo {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
      
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search,
      #suggestRandom,
      .filter-wrap {
        width: 100%;
        min-width: auto;
      }
      
      footer {
        flex-direction: column;
        text-align: center;
      }
    }
    
    /* Loading Animation */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">DB</div>
      <div>
        <h1>Darshan's Picks: Movies & Series</h1>
        <p class="lead">A curated collection of movies & series I watched & loved ‚Äî featuring smart filters, detailed reviews, and personalized recommendations.</p>
      </div>
    </header>

    <section class="controls">
      <div class="search">
        <input id="search" type="search" placeholder="üîç Search movies or series..." />
      </div>

      <button id="suggestRandom" title="Suggest a random unseen movie or series">‚ú® Surprise Me</button>

      <div class="filter-wrap">
        <button id="filterBtn" class="filter-btn" aria-expanded="false" aria-controls="filterMenu">
          Filter Options
        </button>
        <div id="filterMenu" class="filter-menu" role="menu" tabindex="-1" aria-hidden="true">
          <label class="filter-item"><input type="checkbox" data-filter="movies" checked> üé¨ Movies</label>
          <label class="filter-item"><input type="checkbox" data-filter="series" checked> üì∫ Series</label>
          <label class="filter-item"><input type="checkbox" data-filter="rating"> ‚≠ê Rating Descending</label>
          <label class="filter-item"><input type="checkbox" data-filter="year"> üìÖ Year Descending</label>
          <label class="filter-item"><input type="checkbox" data-filter="seen" checked> ‚úÖ Seen</label>
          <label class="filter-item"><input type="checkbox" data-filter="unseen" checked> üéØ Unseen</label>
        </div>
      </div>
    </section>

    <div class="genre-section">
      <div class="genre-header">
        <h3>üé≠ Filter by Genres</h3>
        <button id="clearGenres" class="clear-genres-btn">Clear All</button>
      </div>
      <div class="taglist" id="genres"></div>
    </div>

    <div class="ad" id="ad-top">üí∞ Ad Space ‚Äî Replace with your AdSense / ad network snippet</div>

    <main class="grid" id="grid"></main>

    <div class="ad" id="ad-bottom">üí∞ Ad Space ‚Äî Perfect for affiliate banners or sponsored content</div>

    <footer>
      <div>Made with ‚ù§Ô∏è by Darshan ‚Äî Add your movies/series in the JSON file.</div>
      <div class="small">Tip: Customize colors in CSS variables at the top!</div>
    </footer>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modal-title" style="font-size:24px;color:var(--text-primary)">Title</strong>
        <button id="modal-close" class="close" aria-label="Close modal">√ó</button>
      </div>
      <div class="modal-grid">
        <div id="poster-video-container">
          <img id="modal-poster" class="modal-poster" src="" alt="Poster image" />
          <div id="video-container" class="video-container" style="display:none;">
            <iframe id="trailer-iframe" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </div>
        <div>
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
            <span id="modal-year" class="small" style="color:var(--text-primary)"></span>
            <span id="modal-rating" class="rating"></span>
          </div>
          <p id="modal-desc" style="color:var(--text-secondary);line-height:1.6;margin-bottom:16px"></p>
          <p style="margin-top:16px;font-weight:700;color:var(--text-primary);font-size:16px">üí≠ Why I Liked It</p>
          <p id="modal-notes" style="color:var(--text-secondary);line-height:1.6"></p>
          <div style="margin-top:20px" class="btn-group">
            <button id="play-trailer" class="btn" type="button" style="display:none;">‚ñ∂Ô∏è Play Trailer</button>
            <button id="toggle-fav" class="btn" type="button">Toggle Seen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  let ITEMS = [];

  const state = {
    selectedGenres: new Set(),
    query: '',
    categories: { movies: true, series: true },
    sortRatingDesc: false,
    sortYearDesc: false,
    filterSeen: true,
    filterUnseen: true
  };

  const SEEN_STORAGE_KEY = 'darshan_seen_combined';

  const filterBtn = document.getElementById('filterBtn');
  const filterMenu = document.getElementById('filterMenu');
  const filterItems = filterMenu.querySelectorAll('input[type=checkbox]');
  const genresEl = document.getElementById('genres');
  const grid = document.getElementById('grid');
  const search = document.getElementById('search');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalPoster = document.getElementById('modal-poster');
  const modalDesc = document.getElementById('modal-desc');
  const modalNotes = document.getElementById('modal-notes');
  const modalYear = document.getElementById('modal-year');
  const modalRating = document.getElementById('modal-rating');
  const playTrailer = document.getElementById('play-trailer');
  const toggleFav = document.getElementById('toggle-fav');
  const modalClose = document.getElementById('modal-close');
  const suggestRandomBtn = document.getElementById('suggestRandom');
  const clearGenresBtn = document.getElementById('clearGenres');
  const videoContainer = document.getElementById('video-container');
  const trailerIframe = document.getElementById('trailer-iframe');

  let currentTrailerUrl = null;

  filterBtn.onclick = () => {
    const isOpen = filterMenu.classList.toggle('open');
    filterBtn.setAttribute('aria-expanded', isOpen);
    filterMenu.setAttribute('aria-hidden', !isOpen);
  };

  document.addEventListener('click', e => {
    if (!e.target.closest('.filter-wrap')) {
      filterMenu.classList.remove('open');
      filterBtn.setAttribute('aria-expanded', false);
      filterMenu.setAttribute('aria-hidden', true);
    }
  });

  filterItems.forEach(input => {
    if (input.dataset.filter === 'movies' || input.dataset.filter === 'series') input.checked = true;
    if (input.dataset.filter === 'seen' || input.dataset.filter === 'unseen') input.checked = true;
    input.addEventListener('change', () => {
      const filter = input.dataset.filter;
      if (filter === 'movies') {
        state.categories.movies = input.checked;
      } else if (filter === 'series') {
        state.categories.series = input.checked;
      } else if (filter === 'rating') {
        state.sortRatingDesc = input.checked;
      } else if (filter === 'year') {
        state.sortYearDesc = input.checked;
      } else if (filter === 'seen') {
        state.filterSeen = input.checked;
      } else if (filter === 'unseen') {
        state.filterUnseen = input.checked;
      }
      render();
    });
  });

  clearGenresBtn.addEventListener('click', () => {
    state.selectedGenres.clear();
    renderGenres();
    render();
  });

  function getCurrentList() {
    let out = [];
    if (state.categories.movies) out = out.concat(ITEMS.filter(i => i.type === 'movie'));
    if (state.categories.series) out = out.concat(ITEMS.filter(i => i.type === 'series'));
    return out;
  }

  function getSeenCombined() {
    return new Set(JSON.parse(localStorage.getItem(SEEN_STORAGE_KEY) || '[]'));
  }

  function saveSeen(seen) {
    localStorage.setItem(SEEN_STORAGE_KEY, JSON.stringify(Array.from(seen)));
  }

  function uniqueGenres() {
    const g = new Set();
    getCurrentList().forEach(m => {
      (m.genres || []).forEach(x => g.add(x));
    });
    return Array.from(g).sort();
  }

  function renderGenres() {
    const arr = uniqueGenres();
    genresEl.innerHTML = '';
    
    arr.forEach(g => {
      const label = document.createElement('label');
      label.className = 'tag' + (state.selectedGenres.has(g) ? ' active' : '');
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = state.selectedGenres.has(g);
      checkbox.addEventListener('change', (e) => {
        e.stopPropagation();
        if (checkbox.checked) {
          state.selectedGenres.add(g);
        } else {
          state.selectedGenres.delete(g);
        }
        renderGenres();
        render();
      });
      
      const text = document.createTextNode(g);
      
      label.appendChild(checkbox);
      label.appendChild(text);
      
      label.onclick = (e) => {
        if (e.target !== checkbox) {
          checkbox.checked = !checkbox.checked;
          if (checkbox.checked) {
            state.selectedGenres.add(g);
          } else {
            state.selectedGenres.delete(g);
          }
          renderGenres();
          render();
        }
      };
      
      genresEl.appendChild(label);
    });
  }

  function filterMovies() {
    const seen = getSeenCombined();
    let out = getCurrentList().slice();
    
    if (state.selectedGenres.size > 0) {
      out = out.filter(m => {
        return m.genres.some(genre => state.selectedGenres.has(genre));
      });
    }
    
    if (state.query) {
      const q = state.query.toLowerCase();
      out = out.filter(m => m.title.toLowerCase().includes(q) || (m.notes || '').toLowerCase().includes(q));
    }
    
    if (!state.filterSeen || !state.filterUnseen) {
      out = out.filter(m => {
        const hasSeen = seen.has(m.id);
        if (!state.filterSeen && hasSeen) return false;
        if (!state.filterUnseen && !hasSeen) return false;
        return true;
      });
    }
    
    if (state.sortRatingDesc) {
      out.sort((a,b) => b.rating - a.rating);
    }
    if (state.sortYearDesc) {
      out.sort((a,b) => b.year - a.year);
    }
    return out;
  }

  function render() {
    const items = filterMovies();
    const seen = getSeenCombined();
    grid.innerHTML = '';
    if (items.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;color:var(--text-muted);padding:60px;border-radius:var(--border-radius);background:var(--bg-glass);text-align:center;font-size:16px">üîç No items found matching your filters</div>';
      return;
    }
    items.forEach(m => {
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `
        <div class="poster-wrapper">
          <img class="poster" src="${m.poster}" alt="${m.title} poster" />
        </div>
        <div class="title">${m.title}</div>
        <div class="meta">
          <span style="font-size:12px">${m.genres.slice(0, 2).join(' ‚Ä¢ ')}</span>
        </div>
        <div class="meta">
          <span class="classification">${m.type === 'movie' ? 'Movie' : 'Series'}</span>
          <span class="small">${m.year}</span>
          <span class="rating">${(m.rating || '-')} ‚≠ê</span>
        </div>
        <div class="btn-group">
          <button class="btn" data-id="${m.id}" data-action="open" type="button">Details</button>
          <button class="btn" data-id="${m.id}" data-action="fav" type="button">${seen.has(m.id) ? '‚úÖ Seen' : '‚ûï Mark'}</button>
        </div>`;
      grid.appendChild(c);

      const img = c.querySelector('.poster');
      img.onerror = () => {
        img.style.display = 'none';
      };
    });
  }

  grid.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    const movie = getCurrentList().find(x => x.id === id);
    if (!movie) return;
    const seen = getSeenCombined();
    if (action === 'open') openModal(movie, seen);
    if (action === 'fav') {
      if (seen.has(id)) seen.delete(id);
      else seen.add(id);
      saveSeen(seen);
      render();
    }
  });

  suggestRandomBtn.onclick = () => {
    const seen = getSeenCombined();
    let candidates = getCurrentList().filter(m => !seen.has(m.id));
    
    if (state.selectedGenres.size > 0) {
      candidates = candidates.filter(m => 
        m.genres.some(genre => state.selectedGenres.has(genre))
      );
    }
    
    if (candidates.length === 0) {
      alert('üé¨ No unseen items available matching current filters. Try adjusting your genre selection!');
      return;
    }
    const randIndex = Math.floor(Math.random() * candidates.length);
    openModal(candidates[randIndex], seen);
  };

  function getYouTubeEmbedUrl(url) {
    if (!url) return null;
    
    if (url.includes('youtube.com/embed/')) {
      return url.includes('?') ? url + '&autoplay=1&mute=1' : url + '?autoplay=1&mute=1';
    }
    
    let videoId = null;
    
    if (url.includes('youtube.com/watch?v=')) {
      videoId = url.split('v=')[1]?.split('&')[0];
    } else if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1]?.split('?')[0];
    }
    
    if (videoId) {
      return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1`;
    }
    
    return null;
  }

  function loadTrailer() {
    if (currentTrailerUrl) {
      const embedUrl = getYouTubeEmbedUrl(currentTrailerUrl);
      if (embedUrl) {
        trailerIframe.src = embedUrl;
        modalPoster.style.display = 'none';
        videoContainer.style.display = 'block';
        playTrailer.style.display = 'none';
      }
    }
  }

  function openModal(m, seen) {
    modalTitle.textContent = m.title;
    modalPoster.src = m.poster;
    modalPoster.style.display = 'block';
    videoContainer.style.display = 'none';
    trailerIframe.src = '';
    modalDesc.textContent = (m.genres || []).join(' ‚Ä¢ ');
    modalNotes.textContent = m.notes || '';
    modalYear.textContent = m.year || '';
    modalRating.textContent = typeof m.rating === 'number' ? m.rating + ' ‚≠ê' : '- ‚≠ê';
    
    currentTrailerUrl = m.trailer || null;
    
    if (currentTrailerUrl) {
      playTrailer.style.display = 'flex';
      setTimeout(() => loadTrailer(), 300);
    } else {
      playTrailer.style.display = 'none';
    }
    
    toggleFav.textContent = seen.has(m.id) ? '‚ùå Mark Unseen' : '‚úÖ Mark Seen';
    toggleFav.onclick = () => {
      if (seen.has(m.id)) seen.delete(m.id);
      else seen.add(m.id);
      saveSeen(seen);
      render();
      modal.classList.remove('open');
      trailerIframe.src = '';
      modalPoster.style.display = 'block';
      videoContainer.style.display = 'none';
    };
    
    modal.classList.add('open');
  }

  playTrailer.addEventListener('click', loadTrailer);

  modalClose.addEventListener('click', () => {
    modal.classList.remove('open');
    trailerIframe.src = '';
    modalPoster.style.display = 'block';
    videoContainer.style.display = 'none';
  });

  modal.addEventListener('click', e => {
    if (e.target === modal) {
      modal.classList.remove('open');
      trailerIframe.src = '';
      modalPoster.style.display = 'block';
      videoContainer.style.display = 'none';
    }
  });

  search.addEventListener('input', e => {
    state.query = e.target.value;
    render();
  });

  async function initialize() {
    try {
      const response = await fetch('darshan_movies.json');
      if (!response.ok) {
        throw new Error('Failed to load darshan_movies.json');
      }
      ITEMS = await response.json();
      renderGenres();
      render();
    } catch (error) {
      console.error('Error loading movies data:', error);
      grid.innerHTML = `<div style="grid-column:1/-1;color:var(--text-muted);padding:60px;border-radius:var(--border-radius);background:var(--bg-glass);text-align:center;font-size:16px">‚ö†Ô∏è Error loading movie and series data. Please check your JSON file.</div>`;
    }
  }

  initialize();
</script>
</body>
</html>
